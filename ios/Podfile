source 'https://cdn.cocoapods.org/'

platform :ios, '16.0'

require_relative '../node_modules/react-native/scripts/react_native_pods'
prepare_react_native_project!

# Use static frameworks by default (needed for Firebase Swift)
use_frameworks! :linkage => :static

target 'RuralShareApp' do
  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => true
  )

  # ✅ GoogleMaps & Places MUST be dynamic (avoid duplicate symbols)
  pod 'GoogleMaps', :modular_headers => true
  pod 'GooglePlaces', :modular_headers => true

  rn_maps_path = File.join(__dir__, '../node_modules/react-native-maps')
  pod 'react-native-google-maps', :path => rn_maps_path

  # ✅ Firebase pods (static fine)
  pod 'FirebaseCore'
  pod 'FirebaseAuth'
  
  post_install do |installer|
    react_native_post_install(installer)
    
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.0'
        config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'YES'
        
        # ✅ Fixed: Single EXCLUDED_ARCHS configuration for simulator
        config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
        
        # ✅ Changed: Use YES for debug builds to avoid architecture conflicts
        if config.name == 'Debug'
          config.build_settings['ONLY_ACTIVE_ARCH'] = 'YES'
        else
          config.build_settings['ONLY_ACTIVE_ARCH'] = 'NO'
        end
        
        config.build_settings['OTHER_LDFLAGS'] ||= ['$(inherited)']
        config.build_settings['OTHER_LDFLAGS'] << '-ObjC'
        config.build_settings['GCC_NO_COMMON_BLOCKS'] = 'YES'
      end
    end

    # ✅ Toolchain fix
    installer.aggregate_targets.each do |target|
      target.xcconfigs.each do |variant_name, xcconfig|
        xcconfig_path = target.client_root + target.xcconfig_relative_path(variant_name)
        IO.write(xcconfig_path, IO.read(xcconfig_path).gsub("DT_TOOLCHAIN_DIR", "TOOLCHAIN_DIR"))
      end
    end
    
    # ✅ Additional fix for M1/M2/M4 Macs
    installer.pods_project.build_configurations.each do |config|
      config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
    end
  end
end